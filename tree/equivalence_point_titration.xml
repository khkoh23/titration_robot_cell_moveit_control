<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="equivalence_point_titration">
  <BehaviorTree ID="equivalence_point_titration">
    <Sequence>
      <RunOnce then_skip="true">
        <Fallback>
          <IsStateNormal/>
          <MoveState group_state="normal"/>
        </Fallback>
      </RunOnce>
      <Fallback>
        <CheckPhByRange ph_min="12.01"
                        ph_max="14.00"/>
        <Sequence>
          <MovePose name="MovePoseA1"
                    position_x="0.225"
                    position_y="-0.225"
                    position_z="1.100"/>
          <MovePose name="MovePoseA2"
                    position_x="0.225"
                    position_y="-0.225"
                    position_z="0.860"/>
          <Aspire/>
          <Delay delay_msec="1000">
            <MovePose name="MovePoseA1"
                      position_x="0.225"
                      position_y="-0.225"
                      position_z="1.100"/>
          </Delay>
        </Sequence>
      </Fallback>
      <Fallback>
        <CheckPhByRange ph_min="12.01"
                        ph_max="14.00"/>
        <Sequence>
          <MovePose name="MovePoseB1"
                    position_x="0.225"
                    position_y="0.200"
                    position_z="1.100"/>
          <MovePose name="MovePoseB2"
                    position_x="0.225"
                    position_y="0.200"
                    position_z="1.050"/>
          <ForceSuccess>
            <ReactiveSequence>
              <Inverter>
                <CheckPhByRange ph_min="12.01"
                                ph_max="14.00"/>
              </Inverter>
              <RetryUntilSuccessful num_attempts="-1">
                <Sequence>
                  <IfThenElse>
                    <CheckPhByDelta delta_min="0.01"
                                    delta_max="0.30"
                                    window_sec="2"/>
                    <Sequence>
                      <SetDispenseVolume volume="500"/>
                      <Delay delay_msec="500">
                        <Dispense/>
                      </Delay>
                    </Sequence>
                    <IfThenElse>
                      <CheckPhByDelta delta_min="0.31"
                                      delta_max="0.6"
                                      window_sec="2"/>
                      <Sequence>
                        <SetDispenseVolume volume="100"/>
                        <Delay delay_msec="2500">
                          <Dispense/>
                        </Delay>
                      </Sequence>
                      <IfThenElse>
                        <CheckPhByDelta delta_min="0.61"
                                        delta_max="0.9"
                                        window_sec="2"/>
                        <Sequence>
                          <SetDispenseVolume volume="50"/>
                          <Delay delay_msec="5500">
                            <Dispense/>
                          </Delay>
                        </Sequence>
                        <Sequence>
                          <SetDispenseVolume volume="25"/>
                          <Delay delay_msec="8500">
                            <Dispense/>
                          </Delay>
                        </Sequence>
                      </IfThenElse>
                    </IfThenElse>
                  </IfThenElse>
                  <IsPipetteEmpty/>
                </Sequence>
              </RetryUntilSuccessful>
            </ReactiveSequence>
          </ForceSuccess>
          <Delay delay_msec="1000">
            <MovePose name="MovePoseB1"
                      position_x="0.225"
                      position_y="0.200"
                      position_z="1.100"/>
          </Delay>
        </Sequence>
      </Fallback>
      <Fallback>
        <IfThenElse>
          <CheckPhByRange ph_min="12.01"
                          ph_max="14.00"/>
          <Fallback>
            <IsStateNormal/>
            <MoveState name="MoveStateNormal"
                       group_state="normal"/>
          </Fallback>
          <AlwaysSuccess/>
        </IfThenElse>
      </Fallback>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="Aspire"
            editable="true"/>
    <Condition ID="CheckPhByDelta"
               editable="true">
      <input_port name="delta_min"/>
      <input_port name="delta_max"/>
      <input_port name="window_sec"/>
    </Condition>
    <Condition ID="CheckPhByRange"
               editable="true">
      <input_port name="ph_min"/>
      <input_port name="ph_max"/>
    </Condition>
    <Action ID="Dispense"
            editable="true"/>
    <Condition ID="IsPipetteEmpty"
               editable="true"/>
    <Condition ID="IsStateNormal"
               editable="true"/>
    <Action ID="MovePose"
            editable="true">
      <input_port name="position_x"/>
      <input_port name="position_y"/>
      <input_port name="position_z"/>
    </Action>
    <Action ID="MoveState"
            editable="true">
      <input_port name="group_state"/>
    </Action>
    <Action ID="SetDispenseVolume"
            editable="true">
      <input_port name="volume"/>
    </Action>
  </TreeNodesModel>

</root>
