<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="equivalence_point_titration">
  <BehaviorTree ID="equivalence_point_titration">
    <Sequence>
      <RunOnce then_skip="true">
        <Fallback>
          <IsStateNormal/>
          <MoveState group_state="normal"/>
        </Fallback>
      </RunOnce>
      <Fallback>
        <CheckPhByRange ph_min="12.01"
                        ph_max="14.00"/>
        <Sequence>
          <MovePose name="MovePoseA1"
                    position_x="0.225"
                    position_y="-0.225"
                    position_z="1.100"/>
          <MovePose name="MovePoseA3"
                    position_x="0.225"
                    position_y="-0.225"
                    position_z="0.960"/>
          <ClearPipette/>
          <Delay delay_msec="2000">
            <MovePose name="MovePoseA2"
                      position_x="0.225"
                      position_y="-0.225"
                      position_z="0.860"/>
          </Delay>
          <Delay delay_msec="500">
            <Aspire/>
          </Delay>
          <Delay delay_msec="1000">
            <MovePose name="MovePoseA1"
                      position_x="0.225"
                      position_y="-0.225"
                      position_z="1.100"/>
          </Delay>
        </Sequence>
      </Fallback>
      <Fallback>
        <CheckPhByRange ph_min="12.01"
                        ph_max="14.00"/>
        <Sequence>
          <MovePose name="MovePoseB1"
                    position_x="0.225"
                    position_y="0.200"
                    position_z="1.100"/>
          <MovePose name="MovePoseB2"
                    position_x="0.225"
                    position_y="0.200"
                    position_z="1.050"/>
          <ForceSuccess>
            <ReactiveSequence>
              <Inverter>
                <CheckPhByRange ph_min="12.01"
                                ph_max="14.00"/>
              </Inverter>
              <RetryUntilSuccessful num_attempts="-1">
                <Sequence>
                  <RetryUntilSuccessful num_attempts="-1">
                    <IsPhStable delta_min="0.00"
                                delta_max="0.02"
                                window_sec="3"
                                _description="If pH change is within 0.03 in the last 3 seconds (moving), then True."/>
                  </RetryUntilSuccessful>
                  <IfThenElse>
                    <CheckDphDv criteria_min="0.00000"
                                criteria_max="0.00025"
                                _description="dpH / dV:&#10;If pH change is within 0.05 when volume of 200 was added, then True."/>
                    <Sequence>
                      <SetDispenseVolume volume="200"/>
                      <SetBlackboard value="500"
                                     output_key="delay"/>
                    </Sequence>
                    <IfThenElse>
                      <CheckDphDv criteria_min="0.00026"
                                  criteria_max="0.00050"
                                  _description="dpH / dV:&#10;If pH change is below 0.05 when volume of 100 was added, then True."/>
                      <Sequence>
                        <SetDispenseVolume volume="100"/>
                        <SetBlackboard value="3500"
                                       output_key="delay"/>
                      </Sequence>
                      <Sequence>
                        <SetDispenseVolume volume="50"/>
                        <SetBlackboard value="6500"
                                       output_key="delay"/>
                      </Sequence>
                    </IfThenElse>
                  </IfThenElse>
                  <Delay delay_msec="{delay}">
                    <Dispense/>
                  </Delay>
                  <IsToReplenishPipette/>
                </Sequence>
              </RetryUntilSuccessful>
            </ReactiveSequence>
          </ForceSuccess>
          <Delay delay_msec="1000">
            <MovePose name="MovePoseB1"
                      position_x="0.225"
                      position_y="0.200"
                      position_z="1.100"/>
          </Delay>
        </Sequence>
      </Fallback>
      <Fallback>
        <IfThenElse>
          <CheckPhByRange ph_min="12.01"
                          ph_max="14.00"/>
          <Fallback>
            <IsStateNormal/>
            <MoveState name="MoveStateNormal"
                       group_state="normal"/>
          </Fallback>
          <AlwaysSuccess/>
        </IfThenElse>
      </Fallback>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="Aspire"
            editable="true"/>
    <Condition ID="CheckDphDv"
               editable="true">
      <input_port name="criteria_min"/>
      <input_port name="criteria_max"/>
    </Condition>
    <Condition ID="CheckPhByRange"
               editable="true">
      <input_port name="ph_min"/>
      <input_port name="ph_max"/>
    </Condition>
    <Action ID="ClearPipette"
            editable="true"/>
    <Action ID="Dispense"
            editable="true"/>
    <Condition ID="IsPhStable"
               editable="true">
      <input_port name="delta_min"/>
      <input_port name="delta_max"/>
      <input_port name="window_sec"/>
    </Condition>
    <Condition ID="IsStateNormal"
               editable="true"/>
    <Condition ID="IsToReplenishPipette"
               editable="true"/>
    <Action ID="MovePose"
            editable="true">
      <input_port name="position_x"/>
      <input_port name="position_y"/>
      <input_port name="position_z"/>
    </Action>
    <Action ID="MoveState"
            editable="true">
      <input_port name="group_state"/>
    </Action>
    <Action ID="SetDispenseVolume"
            editable="true">
      <input_port name="volume"/>
    </Action>
  </TreeNodesModel>

</root>
