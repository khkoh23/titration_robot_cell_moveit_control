<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="titration_task">
  <BehaviorTree ID="MoveDispense">
    <Sequence>
      <MovePose name="MovePoseB1"
                position_x="0.225"
                position_y="0.200"
                position_z="1.100"/>
      <MovePose name="MovePoseB2"
                position_x="0.225"
                position_y="0.200"
                position_z="1.050"/>
      <ForceSuccess>
        <ReactiveSequence>
          <Inverter>
            <IsTitrationDone ph_target="7.00"
                             ph_tolerance="0.20"/>
          </Inverter>
          <RetryUntilSuccessful num_attempts="-1">
            <Sequence>
              <Dispense/>
              <IsPipetteEmpty/>
            </Sequence>
          </RetryUntilSuccessful>
        </ReactiveSequence>
      </ForceSuccess>
      <Delay delay_msec="1000">
        <MovePose name="MovePoseB1"
                  position_x="0.225"
                  position_y="0.200"
                  position_z="1.100"/>
      </Delay>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="ReplenishPipette">
    <Sequence>
      <MovePose name="MovePoseA1"
                position_x="0.225"
                position_y="-0.225"
                position_z="1.100"/>
      <MovePose name="MovePoseA2"
                position_x="0.225"
                position_y="-0.225"
                position_z="0.860"/>
      <Aspire/>
      <Delay delay_msec="1000">
        <MovePose name="MovePoseA1"
                  position_x="0.225"
                  position_y="-0.225"
                  position_z="1.100"/>
      </Delay>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="titration_task">
    <Sequence name="TitrationTask">
      <RunOnce then_skip="true">
        <Fallback>
          <IsStateNormal/>
          <MoveState name="MoveStateNormal"
                     group_state="normal"/>
        </Fallback>
      </RunOnce>
      <Fallback>
        <IsTitrationDone ph_target="7.00"
                         ph_tolerance="0.20"/>
        <SubTree ID="ReplenishPipette"/>
      </Fallback>
      <Fallback>
        <IsTitrationDone ph_target="7.00"
                         ph_tolerance="0.20"/>
        <SubTree ID="MoveDispense"/>
      </Fallback>
      <Fallback>
        <IfThenElse>
          <IsTitrationDone ph_target="7.00"
                           ph_tolerance="0.20"/>
          <Fallback>
            <IsStateNormal/>
            <MoveState name="MoveStateNormal"
                       group_state="normal"/>
          </Fallback>
          <AlwaysSuccess/>
        </IfThenElse>
      </Fallback>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="Aspire"
            editable="true"/>
    <Action ID="Dispense"
            editable="true"/>
    <Condition ID="IsPipetteEmpty"
               editable="true"/>
    <Condition ID="IsStateNormal"
               editable="true"/>
    <Condition ID="IsTitrationDone"
               editable="true">
      <input_port name="ph_target"
                  default="7.00"/>
      <input_port name="ph_tolerance"
                  default="0.20"/>
    </Condition>
    <Action ID="MovePose"
            editable="true">
      <input_port name="position_x"/>
      <input_port name="position_y"/>
      <input_port name="position_z"/>
    </Action>
    <Action ID="MoveState"
            editable="true">
      <input_port name="group_state"/>
    </Action>
  </TreeNodesModel>

</root>
